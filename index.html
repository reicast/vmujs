<!DOCTYPE html>
<html>
<head>
  <link rel="image_src" href="logo.jpg">
  <title>VMU.js</title>
</head>
<body style="">

<style>
body {
  text-align: center;
  color: lightgray;
  background: #1a1a1a;
  margin-top: 7%;
  font-size: 266%;
}
  
.images {
	max-width: 6em;
	max-height: 6em;
	padding: 0.5em;
	padding-bottom: 1em;
	padding-top: 0.1em;
}

.drop {
  margin-top: 2em;
	min-height: 6em;
	min-width: 70%;
	max-width: 90%;
	background: #222;
	display: inline-block;
	border: dashed 0.1em gray;
	border-radius: 0.4em;

	position: relative;
}

.drop-footer {
  font-size: 54%;
  color: #997;
  position: absolute;
  bottom: 0px;
  left: 0.2em;
  right: 0.2em;
  padding-bottom: 0.4em;
}

#thumbs {
	padding-bottom: 0.6em;
}

#thumbs > span {
	display: inline-block;
	padding-top: 0.15em;
}

#thumbs > span > div {
	font-size: 0.5em;
	padding: 0.4em;
}

.vmu_hash {
  font-size: 0.9em;
  font-family: monospace;
  font-style: italic;
}

#res {
  border-radius: 0.3em;
  max-width: 90%;
  max-height: 50%;
  
  border: dashed 0.05em darkgray;
  display: inline-block;
  
  margin: 1em;
  margin-bottom: 2em;
  
  background: rgba(0,0,0,0.1);
}

#res img {
  width: 20%;
  margin: 1em;
  border: 1px solid black;
}

.header {
	position: fixed;
	top: 0;
	left: 0;
	right: 0;
	text-align: center;
	color: lightgrey;
	background: black;
	padding: 0.6em 0 0.5em 0;
}

.footer {
	font-size: 0.4em;
	position: fixed;
	bottom: 0.6em;
	left: 0;
	right: 0;
	text-align: center;
	color: lightgrey;
	background: rgba(0,0,0,0.5);
	padding: 0.6em 0 0.5em 0;
}

.vmu_image {
  width: 96px;
  height: 64px;
  margin: auto;
}

</style>
<div class="drop" ondragenter="return false" ondragover="return false" ondrop="dropIt(event)">
    <div id="thumbs"></div>
<span class="drop-footer">Drag and drop a vmu here</span>

</div>

<br />
<div id="res" ></div> <br />


<div class="header">
  A Dreamcast VMU Inspector
</div>

<div class="footer">
  Let's drink some coffee
</div>
	

<script src="jquery-1.10.2.js"></script>
<script>
function sha1Hash(msg)
{
    // constants [4.2.1]
    var K = [0x5a827999, 0x6ed9eba1, 0x8f1bbcdc, 0xca62c1d6];
 
    // PREPROCESSING 
  
    msg += String.fromCharCode(0x80); // add trailing '1' bit to string [5.1.1]
 
    // convert string msg into 512-bit/16-integer blocks arrays of ints [5.2.1]
    var l = Math.ceil(msg.length/4) + 2;  // long enough to contain msg plus 2-word length
    var N = Math.ceil(l/16);              // in N 16-int blocks
    var M = new Array(N);
    for (var i=0; i<N; i++) {
        M[i] = new Array(16);
        for (var j=0; j<16; j++) {  // encode 4 chars per integer, big-endian encoding
            M[i][j] = (msg.charCodeAt(i*64+j*4)<<24) | (msg.charCodeAt(i*64+j*4+1)<<16) | 
                      (msg.charCodeAt(i*64+j*4+2)<<8) | (msg.charCodeAt(i*64+j*4+3));
        }
    }
    // add length (in bits) into final pair of 32-bit integers (big-endian) [5.1.1]
    M[N-1][14] = ((msg.length-1) >>> 30) * 8;
    M[N-1][15] = ((msg.length-1)*8) & 0xffffffff;
 
    // set initial hash value [5.3.1]
    var H0 = 0x67452301;
    var H1 = 0xefcdab89;
    var H2 = 0x98badcfe;
    var H3 = 0x10325476;
    var H4 = 0xc3d2e1f0;
 
    // HASH COMPUTATION [6.1.2]
 
    var W = new Array(80); var a, b, c, d, e;
    for (var i=0; i<N; i++) {
 
        // 1 - prepare message schedule 'W'
        for (var t=0;  t<16; t++) W[t] = M[i][t];
        for (var t=16; t<80; t++) W[t] = ROTL(W[t-3] ^ W[t-8] ^ W[t-14] ^ W[t-16], 1);
 
        // 2 - initialise five working variables a, b, c, d, e with previous hash value
        a = H0; b = H1; c = H2; d = H3; e = H4;
 
        // 3 - main loop
        for (var t=0; t<80; t++) {
            var s = Math.floor(t/20); // seq for blocks of 'f' functions and 'K' constants
            var T = (ROTL(a,5) + f(s,b,c,d) + e + K[s] + W[t]) & 0xffffffff;
            e = d;
            d = c;
            c = ROTL(b, 30);
            b = a;
            a = T;
        }
 
        // 4 - compute the new intermediate hash value
        H0 = (H0+a) & 0xffffffff;  // note 'addition modulo 2^32'
        H1 = (H1+b) & 0xffffffff; 
        H2 = (H2+c) & 0xffffffff; 
        H3 = (H3+d) & 0xffffffff; 
        H4 = (H4+e) & 0xffffffff;
    }
 
    return H0.toHexStr() + H1.toHexStr() + H2.toHexStr() + H3.toHexStr() + H4.toHexStr();
}
 
//
// function 'f' [4.1.1]
//
function f(s, x, y, z) 
{
    switch (s) {
    case 0: return (x & y) ^ (~x & z);
    case 1: return x ^ y ^ z;
    case 2: return (x & y) ^ (x & z) ^ (y & z);
    case 3: return x ^ y ^ z;
    }
}
 
//
// rotate left (circular left shift) value x by n positions [3.2.5]
//
function ROTL(x, n)
{
    return (x<<n) | (x>>>(32-n));
}
 
//
// extend Number class with a tailored hex-string method 
//   (note toString(16) is implementation-dependant, and 
//   in IE returns signed numbers when used on full words)
//
Number.prototype.toHexStr = function()
{
    var s="", v;
    for (var i=7; i>=0; i--) { v = (this>>>(i*4)) & 0xf; s += v.toString(16); }
    return s;
}
</script>
<script>
function imagesSelected(myFiles) {
  if (myFiles.length != 1)
    alert("Please drop a single file");
  else {
    var file = myFiles[0];
    
    $('#thumbs').empty();
    $('#thumbs').append(['<span >', file.name, '<div>id <span class="vmu_hash"></span></div></span><br />','<canvas class="vmu_image" ></canvas>'].join(''));
     
     
     var reader = new FileReader();

      // Closure to capture the file information.
      reader.onload = 
      function(e) {
        vmu = new Uint8Array(e.target.result);
        var hash = "";
        for (var i =0x15; i<=0x3f;i++) {
          hash += ("00" + vmu[255*512 + i]).slice(-2);
        }
        hash = sha1Hash(hash);
        $(".vmu_hash").text("#" + hash);
        
        color = "128, 128, 128, 255";
        
        if (vmu[255*512 + 0x10]) {
          color =  vmu[255*512 + 0x11] + ", " + vmu[255*512 + 0x12] + ", " 
                 + vmu[255*512 + 0x13] + ", " + vmu[255*512 + 0x14];
        }
        
        
        
        $(".vmu_image").css({ backgroundColor: "rgba(" + color + ")"});
        $("#res").empty();

        for (var i = 253; i>=241; i--) {
          for (var j=0; j<(512/32); j++) {
            var base = i * 512 + j* 32;
            
            if (vmu[base + 0]) {
              var file = {};
              file.type = vmu[base + 0] == 0x33 ? "data" : "game";
              file.copyProtect = vmu[base + 1] == 0xff;
              file.firstBlock = vmu[base + 2] | vmu[base + 3] *256;
              
              file.name = "";
              for (var k = 0x4; k<= 0xf; k++) 
                file.name += String.fromCharCode(vmu[base + k]);

              file.timestamp = Array.prototype.join.call(vmu.subarray(base + 0x10, base + 0x18), "");
              file.fileSize = vmu[base + 0x18] | vmu[base + 0x19] *256;
              file.headerOffset = vmu[base + 0x1a] | vmu[base + 0x1b] *256;
              file.extra = Array.prototype.join.call(vmu.subarray(base + 0x1c, base + 0x20), " ");

              $('#res').append($("<div>").text(file.name).attr("title", JSON.stringify(file)));
            }
          }
        }
      };

      // Read in the image file as a data URL.
      reader.readAsArrayBuffer(file)
      
  }
}

function dropIt(e) {  
   e.stopPropagation();
   e.preventDefault();
   imagesSelected(e.dataTransfer.files);
}
</script>

<!-- I Really love people that inspect pages <3 -->
</body></html>
